name: Deploy Production

on:
  workflow_dispatch:
  push:
    tags:
      - "v*"

concurrency:
  group: deploy-production
  cancel-in-progress: false

jobs:
  deploy:
    if: ${{ hashFiles('server/CMakeLists.txt') != '' || hashFiles('server/Makefile') != '' }}
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://stream.winnowscout.com
    steps:
      - uses: actions/checkout@v4

      - name: Configure doctl
        if: ${{ secrets.DIGITAL_OCEAN_KEY != '' }}
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITAL_OCEAN_KEY }}

      - name: DigitalOcean account info
        if: ${{ secrets.DIGITAL_OCEAN_KEY != '' }}
        run: doctl account get

      - name: Install server deps
        if: ${{ hashFiles('server/**') != '' }}
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential cmake pkg-config \
            libwebsockets-dev libssl-dev \
            gstreamer1.0-tools gstreamer1.0-plugins-base \
            gstreamer1.0-plugins-good gstreamer1.0-plugins-bad \
            gstreamer1.0-plugins-ugly gstreamer1.0-libav \
            libgstreamer1.0-dev libgstreamer-plugins-base1.0-dev

      - name: Build server (CMake)
        if: ${{ hashFiles('server/CMakeLists.txt') != '' }}
        run: |
          cmake -S server -B build
          cmake --build build

      - name: Build server (Makefile)
        if: ${{ hashFiles('server/Makefile') != '' }}
        run: make -C server

      - name: Setup Node
        if: ${{ hashFiles('client/package.json') != '' }}
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: client/package-lock.json

      - name: Build client
        if: ${{ hashFiles('client/package.json') != '' }}
        run: |
          cd client
          npm ci
          npm run build

      - name: Locate artifacts
        run: |
          if [ -f build/cube_server ]; then
            echo "SERVER_BIN=build/cube_server" >> "$GITHUB_ENV"
          elif [ -f server/cube_server ]; then
            echo "SERVER_BIN=server/cube_server" >> "$GITHUB_ENV"
          elif [ -f server/bin/cube_server ]; then
            echo "SERVER_BIN=server/bin/cube_server" >> "$GITHUB_ENV"
          else
            echo "Server binary not found." >&2
            exit 1
          fi

          if [ -d client/dist ]; then
            echo "CLIENT_DIST=client/dist" >> "$GITHUB_ENV"
          else
            echo "CLIENT_DIST=" >> "$GITHUB_ENV"
          fi

      - name: Install rsync
        run: sudo apt-get update && sudo apt-get install -y rsync openssh-client

      - name: Deploy artifacts
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_KEY: ${{ secrets.SSH_KEY }}
        run: |
          set -euo pipefail
          if [ -z "$SSH_HOST" ] || [ -z "$SSH_USER" ] || [ -z "$SSH_KEY" ]; then
            echo "SSH_HOST, SSH_USER, and SSH_KEY secrets are required." >&2
            exit 1
          fi

          mkdir -p ~/.ssh
          printf "%s" "$SSH_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H "$SSH_HOST" >> ~/.ssh/known_hosts

          release_dir="/opt/cube-streamer/releases/${GITHUB_SHA}"
          ssh -i ~/.ssh/id_ed25519 "$SSH_USER@$SSH_HOST" \
            "mkdir -p \"$release_dir/bin\" \"$release_dir/client\""

          rsync -az -e "ssh -i ~/.ssh/id_ed25519" \
            "$SERVER_BIN" "$SSH_USER@$SSH_HOST:$release_dir/bin/cube_server"

          if [ -n "${CLIENT_DIST:-}" ] && [ -d "$CLIENT_DIST" ]; then
            rsync -az --delete -e "ssh -i ~/.ssh/id_ed25519" \
              "$CLIENT_DIST/" "$SSH_USER@$SSH_HOST:$release_dir/client/"
          fi

          ssh -i ~/.ssh/id_ed25519 "$SSH_USER@$SSH_HOST" \
            "ln -sfn \"$release_dir\" /opt/cube-streamer/current && sudo /usr/bin/systemctl restart cube-server"

          ssh -i ~/.ssh/id_ed25519 "$SSH_USER@$SSH_HOST" \
            "ls -1dt /opt/cube-streamer/releases/* | tail -n +6 | xargs -r rm -rf"
